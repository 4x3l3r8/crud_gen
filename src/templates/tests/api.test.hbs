{{!-- API Test Generator (Vitest + MSW) --}}
import setupStore from '@/store';
import { BASE_URL } from '@/store/api';
import {
useGet{{plural}}Query,
useGet{{pascalCase entity}}Query,
useCreate{{pascalCase entity}}Mutation,
useUpdate{{pascalCase entity}}Mutation,
{{camelCase entity}}Api,
useDelete{{pascalCase entity}}Mutation,
} from '@/store/{{camelCase entity}}/{{camelCase entity}}Api';
import type { {{pascalCase entity}} } from '@/types/{{camelCase entity}}';
import { renderHookWithProviders } from '@/utils/test-utils';
import { waitFor } from '@testing-library/react';
import { http, HttpResponse } from 'msw';
import { setupServer } from 'msw/node';
import { afterAll, afterEach, beforeAll, describe, expect, it } from 'vitest';


const mock{{pascalCase entity}}: {{pascalCase entity}} = {
id: '1',
{{#each fields}}
{{#ifNeq name 'id'}}
{{#ifNeq type 'computed'}}
{{name}}: {{defaultValue}},
{{/ifNeq}}
{{/ifNeq}}
{{/each}}
};

const server = setupServer(
http.get(`${BASE_URL}{{apiEndpoint}}`, () => {
return HttpResponse.json({
data: [mock{{pascalCase entity}}],
success: true,
meta: { total: 1, page: 1, limit: 20 },
});
}),

http.get(`${BASE_URL}{{apiEndpoint}}/:id`, ({ params }) => {
return HttpResponse.json({
data: mock{{pascalCase entity}},
success: true,
});
}),

http.post(`${BASE_URL}{{apiEndpoint}}`, async ({ request }) => {
const body = await request.json();
return HttpResponse.json({
data: { ...mock{{pascalCase entity}}, ...body },
success: true,
});
}),

http.put(`${BASE_URL}{{apiEndpoint}}/:id`, async ({ params, request }) => {
const body = await request.json();
return HttpResponse.json({
data: { ...mock{{pascalCase entity}}, ...body },
success: true,
});
}),

http.delete(`${BASE_URL}{{apiEndpoint}}/:id`, () => {
return HttpResponse.json({
success: true,
});
})
);

describe('{{camelCase entity}}Api', () => {
beforeAll(() => server.listen());
afterEach(() => {
server.resetHandlers();
setupStore().dispatch({{camelCase entity}}Api.util.resetApiState());
});
afterAll(() => server.close());

describe('useGet{{plural}}Query', () => {
it('should fetch {{camelCase entity}} list', async () => {
const { result } = renderHookWithProviders(() => useGet{{plural}}Query({ page: 1 }));
await waitFor(() => expect(result.current.isSuccess).toBe(true));

expect(result.current.data?.data).toHaveLength(1);
expect(result.current.data?.data[0].id).toBe('1');
});
});

describe('useGet{{pascalCase entity}}Query', () => {
it('should fetch single {{camelCase entity}}', async () => {
const { result } = renderHookWithProviders(() => useGet{{pascalCase entity}}Query('1'));

await waitFor(() => expect(result.current.isSuccess).toBe(true));

expect(result.current.data?.data.id).toBe('1');
});
});

describe('useCreate{{pascalCase entity}}Mutation', () => {
it('should create a new {{camelCase entity}}', async () => {
const { result } = renderHookWithProviders(() => useCreate{{pascalCase entity}}Mutation());

await result.current[0]({
{{#each formFields}}
{{#ifNeq name 'id'}}
{{#ifNeq type 'computed'}}
{{name}}: {{defaultValue}},
{{/ifNeq}}
{{/ifNeq}}
});

await waitFor(() => expect(result.current[1].isSuccess).toBe(true));
});
});

describe('useUpdate{{pascalCase entity}}Mutation', () => {
it('should update a {{camelCase entity}}', async () => {
const { result } = renderHookWithProviders(() => useUpdate{{pascalCase entity}}Mutation());

await result.current[0]({
id: '1',
data: {
{{#each formFields}}
{{#ifNeq name 'id'}}
{{#ifNeq type 'computed'}}
{{name}}: {{defaultValue}},
{{/ifNeq}}
{{/ifNeq}}
},
});

await waitFor(() => expect(result.current[1].isSuccess).toBe(true));
});
});

describe('useDelete{{pascalCase entity}}Mutation', () => {
it('should delete a {{camelCase entity}}', async () => {
const { result } = renderHookWithProviders(() => useDelete{{pascalCase entity}}Mutation());

await result.current[0]('1');

await waitFor(() => expect(result.current[1].isSuccess).toBe(true));
});
});
});